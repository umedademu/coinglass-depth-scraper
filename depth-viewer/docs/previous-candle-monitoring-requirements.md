# 1å€‹å‰ã®è¶³ç›£è¦–æ©Ÿèƒ½ - è¦ä»¶å®šç¾©æ›¸

## ğŸ“Œ æ¦‚è¦
ã€Œæ—©ã„è€…è² ã‘å•é¡Œã€ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ç¾åœ¨ã®è¶³ã«åŠ ãˆã¦1å€‹å‰ã®è¶³ã¾ã§Realtimeç›£è¦–ã‚’ç¶™ç¶šã—ã€å¾Œã‹ã‚‰åˆ°ç€ã—ãŸæ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€å¤§å€¤ï¼‰ã‚’åæ˜ ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ğŸ”´ ç¾åœ¨ã®å•é¡Œï¼šæ—©ã„è€…è² ã‘å•é¡Œ

### å•é¡Œã®ã‚·ãƒŠãƒªã‚ª
```
æ™‚ç³»åˆ—ï¼ˆ5åˆ†è¶³ã®ä¾‹ï¼‰:
12:00:00 - ãƒ¦ãƒ¼ã‚¶ãƒ¼Aï¼ˆè‡ªåˆ†ï¼‰ãŒ1ç•ªä¹—ã‚Šã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
         â†’ Supabaseã«è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¡ç”¨ã•ã‚Œã‚‹
         â†’ ãƒ­ãƒ¼ã‚«ãƒ«DBã‚‚è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã§ç¢ºå®š

12:00:30 - ãƒ¦ãƒ¼ã‚¶ãƒ¼Bï½Zï¼ˆ99äººï¼‰ãŒå¾Œã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
         â†’ Supabaseã§æœ€å¤§å€¤ãŒæ›´æ–°ã•ã‚Œã‚‹ï¼ˆæ­£ã—ã„å€¤ï¼‰
         â†’ ã—ã‹ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¯æ—¢ã«12:00ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šæ¸ˆã¿

12:05:00 - ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¯12:00ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ãªã„
         â†’ 99äººã®æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã§ããªã„ï¼
```

### ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã®ä¾‹
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼Aï¼ˆ1ç•ªä¹—ã‚Šï¼‰**: Ask 7,344 / Bid 11,907ï¼ˆå°ã•ã„å€¤ã®ã¾ã¾ï¼‰
- **Supabaseï¼ˆæœ€å¤§å€¤ï¼‰**: Ask 7,962 / Bid 14,001ï¼ˆæ­£ã—ã„å€¤ï¼‰
- **å·®åˆ†**: Ask +618 / Bid +2,094ï¼ˆã“ã®å·®åˆ†ãŒåæ˜ ã•ã‚Œãªã„ï¼‰

## ğŸ’¡ è§£æ±ºç­–ï¼š1å€‹å‰ã®è¶³ã¾ã§ç›£è¦–

### åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
```
ç¾åœ¨æ™‚åˆ»: 12:10ã®å ´åˆ

ã€å¾“æ¥ã®ç›£è¦–ç¯„å›²ã€‘
- 12:10ã®è¶³ã®ã¿ï¼ˆç¾åœ¨ã®è¶³ï¼‰

ã€æ–°ã—ã„ç›£è¦–ç¯„å›²ã€‘
- 12:10ã®è¶³ï¼ˆç¾åœ¨ã®è¶³ï¼‰
- 12:05ã®è¶³ï¼ˆ1å€‹å‰ã®è¶³ï¼‰â† è¿½åŠ ã§ç›£è¦–ï¼
```

### æ™‚é–“è¶³ã”ã¨ã®ç›£è¦–ç¯„å›²

| æ™‚é–“è¶³ | ç›£è¦–ç¯„å›² | ä¾‹ï¼ˆç¾åœ¨12:30ã®å ´åˆï¼‰ |
|--------|----------|------------------------|
| 5åˆ†è¶³ | éå»5åˆ†å‰ã¾ã§ | 12:25ï½12:30ã‚’ç›£è¦– |
| 15åˆ†è¶³ | éå»15åˆ†å‰ã¾ã§ | 12:15ï½12:30ã‚’ç›£è¦– |
| 30åˆ†è¶³ | éå»30åˆ†å‰ã¾ã§ | 12:00ï½12:30ã‚’ç›£è¦– |
| 1æ™‚é–“è¶³ | éå»1æ™‚é–“å‰ã¾ã§ | 11:00ï½12:00ã‚’ç›£è¦– |
| 2æ™‚é–“è¶³ | éå»2æ™‚é–“å‰ã¾ã§ | 10:00ï½12:00ã‚’ç›£è¦– |
| 4æ™‚é–“è¶³ | éå»4æ™‚é–“å‰ã¾ã§ | 08:00ï½12:00ã‚’ç›£è¦– |
| æ—¥è¶³ | éå»1æ—¥å‰ã¾ã§ | å‰æ—¥00:00ï½ä»Šæ—¥00:00ã‚’ç›£è¦– |

## âœ… å®Ÿè£…æ–¹é‡

### 1. Realtimeç›£è¦–ç¯„å›²ã®è¨ˆç®—
```python
def calculate_monitoring_range(timeframe: str, current_time: datetime):
    """ç›£è¦–ã™ã¹ãã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç¯„å›²ã‚’è¨ˆç®—"""
    
    timeframe_minutes = {
        'order_book_shared': 5,    # 5åˆ†è¶³
        'order_book_15min': 15,
        'order_book_30min': 30,
        'order_book_1hour': 60,
        'order_book_2hour': 120,
        'order_book_4hour': 240,
        'order_book_daily': 1440   # æ—¥è¶³
    }
    
    minutes = timeframe_minutes.get(table_name, 5)
    
    # ç¾åœ¨ã®è¶³ã®é–‹å§‹æ™‚åˆ»
    current_candle_start = floor_to_timeframe(current_time, minutes)
    
    # 1å€‹å‰ã®è¶³ã®é–‹å§‹æ™‚åˆ»
    previous_candle_start = current_candle_start - timedelta(minutes=minutes)
    
    return (previous_candle_start, current_candle_start)
```

### 2. Realtimeè³¼èª­ã®ä¿®æ­£
```python
def setup_realtime_monitoring():
    """1å€‹å‰ã®è¶³ã¾ã§ç›£è¦–ã™ã‚‹Realtimeè¨­å®š"""
    
    # ç›£è¦–ç¯„å›²ã‚’è¨ˆç®—
    start_time, end_time = calculate_monitoring_range(table_name, now)
    
    # ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’è¨­å®š
    channel.on_postgres_changes(
        event='*',  # INSERT, UPDATE, DELETE
        schema='public',
        table=table_name,
        filter=f'group_id=eq.{group_id}',
        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç¯„å›²ã®ãƒ•ã‚£ãƒ«ã‚¿ã¯åˆ¥é€”å‡¦ç†ã§å®Ÿè£…
        callback=handle_realtime_update
    )
```

### 3. ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†
```python
def handle_realtime_update(payload):
    """Realtimeã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†"""
    
    new_data = payload.get('new', {})
    timestamp = new_data.get('timestamp')
    
    # ç›£è¦–ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
    start_time, end_time = calculate_monitoring_range(table_name, now)
    
    if start_time <= timestamp <= end_time:
        # æœ€å¤§å€¤æ¯”è¼ƒã—ã¦æ›´æ–°
        update_local_db_with_max_values(new_data)
        
        # 1å€‹å‰ã®è¶³ã®æ›´æ–°ã®å ´åˆã¯ãƒ­ã‚°å‡ºåŠ›
        if timestamp < current_candle_start:
            log(f"[1å€‹å‰ã®è¶³æ›´æ–°] {timestamp}ã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ€å¤§å€¤ã§æ›´æ–°")
```

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### Beforeï¼ˆç¾åœ¨ã®å•é¡Œï¼‰
- 1ç•ªä¹—ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã§å›ºå®š
- å¾Œã‹ã‚‰æ¥ãŸæ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã§ããªã„
- ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆãŒç™ºç”Ÿ

### Afterï¼ˆæ”¹å–„å¾Œï¼‰
- 1ç•ªä¹—ã‚Šã§ã‚‚å¾Œã‹ã‚‰æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°
- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ä¸€è²«ã—ãŸãƒ‡ãƒ¼ã‚¿
- æœ€å¤§å€¤ï¼ˆæ­£ã—ã„å€¤ï¼‰ã®ç¢ºå®Ÿãªåæ˜ 

## ğŸ¯ å®Ÿè£…å„ªå…ˆåº¦

1. **ç¬¬1æ®µéš**: Realtimeã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ï¼ˆå‰ææ¡ä»¶ï¼‰
2. **ç¬¬2æ®µéš**: 1å€‹å‰ã®è¶³ç›£è¦–æ©Ÿèƒ½ã®å®Ÿè£…
3. **ç¬¬3æ®µéš**: å‹•ä½œæ¤œè¨¼ã¨ãƒ­ã‚°ç›£è¦–

## ğŸ“ ãƒ†ã‚¹ãƒˆè¨ˆç”»

### ã‚·ãƒŠãƒªã‚ª1: åŸºæœ¬å‹•ä½œç¢ºèª
1. 12:00ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2. 12:01ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼BãŒã‚ˆã‚Šå¤§ãã„å€¤ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã®ãƒ­ãƒ¼ã‚«ãƒ«DBãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### ã‚·ãƒŠãƒªã‚ª2: å¢ƒç•Œæ¡ä»¶ãƒ†ã‚¹ãƒˆ
1. 12:05ã«ãªã£ãŸç¬é–“ã®å‹•ä½œç¢ºèª
2. 12:00ã®ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ç›£è¦–å¯¾è±¡ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
3. 11:55ã®ãƒ‡ãƒ¼ã‚¿ã¯ç›£è¦–å¯¾è±¡å¤–ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

### ã‚·ãƒŠãƒªã‚ª3: å…¨æ™‚é–“è¶³ã§ã®å‹•ä½œç¢ºèª
- 5åˆ†è¶³ã€15åˆ†è¶³ã€30åˆ†è¶³ã€1æ™‚é–“è¶³ã€2æ™‚é–“è¶³ã€4æ™‚é–“è¶³ã€æ—¥è¶³
- ãã‚Œãã‚Œã§1å€‹å‰ã®è¶³ãŒæ­£ã—ãç›£è¦–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

## âš ï¸ è€ƒæ…®äº‹é …

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ç›£è¦–ç¯„å›²ã‚’1å€‹å‰ã«é™å®šï¼ˆãã‚Œä»¥å‰ã¯æ¥µã‚ã¦ç¨€ï¼‰
- ä¸è¦ãªå¤ã„ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã‚’é¿ã‘ã‚‹

### ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œ
- è¶³ã®åˆ‡ã‚Šæ›¿ã‚ã‚Šã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã®å‡¦ç†
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®è€ƒæ…®ï¼ˆJSTã§çµ±ä¸€ï¼‰

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- Realtimeæ¥ç¶šæ–­æ™‚ã®å‡¦ç†
- ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆæ™‚ã®è­¦å‘Š

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `realtime_sync.py`: Realtimeç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯
- `cloud_sync.py`: ãƒ‡ãƒ¼ã‚¿åŒæœŸç®¡ç†
- `coinglass_scraper.py`: ãƒ­ãƒ¼ã‚«ãƒ«DBæ›´æ–°

## ğŸ“š å‚è€ƒæƒ…å ±
- ç¾åœ¨ã¯å…¨æ™‚é–“è¶³ã®å…¨INSERTã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ï¼ˆæ™‚é–“ç¯„å›²åˆ¶é™ãªã—ï¼‰
- `fetch_initial_data()`ã§èµ·å‹•æ™‚ã«æœ€æ–°1000ä»¶ã‚’å–å¾—
- ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€Œæ—©ã„è€…è² ã‘å•é¡Œã€ãŒæ ¹æœ¬çš„ã«è§£æ±ºã•ã‚Œã‚‹