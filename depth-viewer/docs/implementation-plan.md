# Depth Viewer Web版 実装計画

## 📌 このドキュメントについて

これはBTC-USDT板情報をブラウザで表示するWebアプリケーション（https://depth-viewer.vercel.app/）の実装を段階的に進めるための計画書です。
各段階で動作確認を行いながら、確実に機能を積み上げていく開発手法を採用しています。

**重要**: 実装を始める前に、必ずこのドキュメント全体を読んでください。

**実装状況**: 
- 第0段階：テストページのデプロイ ✅ 完了
- 第1段階：Supabase接続確認 ✅ 完了
- 第2段階：データ取得と表示 ✅ 完了
- 第3段階：静的グラフの実装 🔄 未着手
- 第4段階：タイムフレーム切り替え 🔄 未着手
- 第5段階：リアルタイム更新 🔄 未着手
- 第6段階：UI/UXの最適化 🔄 未着手

## 🎯 実装方針

1. **段階的実装**: 6つの段階に分けて、各段階で動作確認を行う
2. **既存資産の活用**: Pythonアプリのデザインと計算ロジックを踏襲
3. **認証なし**: URLを知っていれば誰でも閲覧可能（第1版）
4. **モバイルファースト**: レスポンシブデザインで全デバイス対応

## 📍 実装の前提条件

**重要**: 実装を開始する前に、以下の前提条件を確認してください：

### データベース環境
- Supabaseプロジェクト「depth」が稼働中
- `order_book_shared`テーブルに約6,000件のデータが存在
- Pythonスクレーパーが5分ごとにデータを追加中
- group_idは「default-group」で統一

### 開発環境
- Node.js 18以上がインストール済み
- Vercelアカウントが設定済み
- GitHubリポジトリと連携済み

## 📋 実装段階

### 第1段階：Supabase接続確認 🎯難易度: 15/100

#### 目標
Supabaseに接続し、データが取得できることを確認する。

#### タスク
- Supabase Anon Keyの取得と環境変数設定
- Supabaseクライアントの初期化
- 最新10件のデータ取得
- コンソールにデータを出力

#### 確認項目
```
✅ ユーザーへの確認指示：
「実装が完了しました。以下をチェックしてください：
1. npm run dev でローカルサーバーを起動
2. http://localhost:3000 にアクセス
3. F12キーで開発者コンソールを開く
4. コンソールに以下が表示される：
   - "Supabase connected successfully"
   - 10件のデータ（timestamp, ask_total, bid_total, price）
5. エラーが表示されていない

問題なければOKです！」
```

---

### 第2段階：データ取得と表示 🎯難易度: 25/100

#### 目標
取得したデータを画面上にテーブル形式で表示する。

#### タスク
- 最新100件のデータを取得
- テーブルコンポーネントの作成
- timestamp、売り板、買い板、価格を表示
- 買い/売り比率の計算と表示
- 最終更新時刻の表示

#### 確認項目
```
✅ ユーザーへの確認指示：
「実装が完了しました。以下をチェックしてください：
1. http://localhost:3000 にアクセス
2. ページ上部に現在の情報が表示される：
   - 最新価格（例：$117,721）
   - 売り板総量（例：7,502 BTC）
   - 買い板総量（例：13,945 BTC）
   - 買い/売り比率（例：1.86）
3. テーブルに100行のデータが表示される
4. 各行にtimestamp、ask、bid、priceが表示される
5. タイムスタンプが日本時間で表示される

データが正しく表示されていればOKです！」
```

---

### 第3段階：静的グラフの実装 🎯難易度: 45/100

#### 目標
Chart.jsまたはRechartsを使用して、Pythonアプリと同じ見た目のグラフを表示する。

#### タスク
- グラフライブラリのインストールと設定
- グラフ表示用に最新300件のデータ取得（テーブルは100件のまま）
- 売り板グラフ（赤色）の実装
  - **Y軸を反転（多いほど下に迫ってくる表現）**
- 買い板グラフ（緑色）の実装
- 2つのグラフを上下に配置
  - **重要：売り板と買い板のグラフは隙間なく連続させる**
  - グラフ間に余白、タイトル、ラベル等を一切入れない
  - 視覚的に1つの連続したグラフのように見せる
- 両グラフの縦軸スケールを統一（デスクトップ版と同じ表現）
  - 実装方法：
    1. 売り板の最小値・最大値を取得（例：min=7,000 BTC、max=8,000 BTC）
    2. 買い板の最小値・最大値を取得（例：min=13,000 BTC、max=14,500 BTC）
    3. 各板の変動幅を計算
       - 売り板の変動幅 = 8,000 - 7,000 = 1,000 BTC
       - 買い板の変動幅 = 14,500 - 13,000 = 1,500 BTC
    4. より大きい変動幅を「共通幅」として採用（この例では1,500 BTC）
    5. 各グラフの表示範囲を設定：
       - 売り板：7,000〜8,500 BTC（最小値から共通幅分）
       - 買い板：13,000〜14,500 BTC（最小値から共通幅分）
  - 効果：両グラフで価格変動の視覚的なインパクトが同じになる
  - 注意：売り板はY軸反転のため、上限値が下側に表示される
- X軸（時刻）とY軸（BTC数量）の設定
- グリッド線とダークテーマの適用

#### 確認項目
```
✅ ユーザーへの確認指示：
「実装が完了しました。以下をチェックしてください：
1. http://localhost:3000 にアクセス
2. 画面中央に2つのグラフが表示される：
   - 上段：売り板の推移（赤色の線、下向きに成長）
   - 下段：買い板の推移（緑色の線、上向きに成長）
3. グラフの背景がダーク（#1e1e1e）
4. **売り板グラフと買い板グラフが隙間なく連続している**
   - 2つのグラフの境界線が直接接している
   - グラフ間にタイトルや余白が入っていない
5. グリッド線が薄く表示される
6. X軸に時刻、Y軸にBTC数量が表示される
7. **両グラフの縦軸の「見た目の変動幅」が同じ**
   - 売り板が1,000 BTC変動、買い板が2,000 BTC変動の場合
   - 両方とも同じ高さのグラフ領域で表現される
   - 片方だけが極端に平坦にならない
8. マウスホバーで値が表示される
9. グラフに約300個のデータポイントが表示される
10. Pythonアプリと見た目が似ている

グラフが正しく表示されていればOKです！」
```

※ デスクトップ版では売り板と買い板が1つの連続した板情報として
  視覚的に認識できるよう、グラフ間に何も挟まない設計になっています。
  これにより、売り板の圧力と買い板の支えが直感的に把握できます。

---

### 第4段階：タイムフレーム切り替え 🎯難易度: 55/100

#### 目標
ユーザーが表示期間を切り替えられる機能を実装する。

#### タスク
- タイムフレーム選択ドロップダウンの追加
- 1分、5分、15分、1時間、1日の選択肢
- 選択に応じたデータフィルタリング
- 1分データの補間処理（元データは5分間隔）
- グラフの再描画処理
- 選択状態の保持

#### 確認項目
```
✅ ユーザーへの確認指示：
「実装が完了しました。以下をチェックしてください：
1. http://localhost:3000 にアクセス
2. ページ上部にタイムフレーム選択ボタンがある
3. 「5分」を選択：
   - 最新5分間のデータが表示される
   - データポイントが1つまたは2つ
4. 「1時間」を選択：
   - 最新1時間のデータが表示される
   - データポイントが12個程度
5. 「1日」を選択：
   - 最新24時間のデータが表示される
   - データポイントが288個程度
6. 切り替え時にグラフが即座に更新される
7. ページリロード後も選択が保持される

タイムフレーム切り替えが動作すればOKです！」
```

---

### 第5段階：リアルタイム更新 🎯難易度: 70/100

#### 目標
Supabase RealtimeでWebSocket接続し、データ更新時に自動的にグラフを更新する。

#### タスク
- Supabase Realtime購読の設定
- WebSocket接続の確立
- 新規データ受信時の処理
- グラフへのデータ追加（アニメーション付き）
- 接続状態インジケーターの表示
- 接続エラー時の再接続処理
- メモリリーク対策（古いデータの削除）

#### 確認項目
```
✅ ユーザーへの確認指示：
「実装が完了しました。以下をチェックしてください：
1. http://localhost:3000 にアクセス
2. ページ右上に接続状態が表示される：
   - 緑の●：接続中
   - 黄の●：接続中...
   - 赤の●：切断
3. 5分間ページを開いたままにする
4. 5分後に以下が自動的に起こる：
   - 「データ更新」の通知が表示される
   - グラフに新しいポイントが追加される
   - 最新価格が更新される
   - ページリロードは不要
5. ネットワークを一時切断して再接続：
   - 自動的に再接続される
   - データの欠損がない

リアルタイム更新が動作すればOKです！
※Pythonスクレーパーが動作している必要があります」
```

---

### 第6段階：UI/UXの最適化 🎯難易度: 40/100

#### 目標
ユーザビリティを向上させ、プロフェッショナルな見た目に仕上げる。

#### タスク
- ローディング画面の実装
- エラー画面の実装（データ取得失敗時）
- レスポンシブデザインの調整
- スマートフォン用の縦画面対応
- タブレット用の最適化
- データ更新時のアニメーション追加
- ツールチップの改善
- パフォーマンス最適化

#### 確認項目
```
✅ ユーザーへの確認指示：
「実装が完了しました。以下をチェックしてください：

【デスクトップ】
1. http://localhost:3000 にアクセス
2. 初回ロード時にローディング画面が表示される
3. データ更新時に滑らかなアニメーション
4. 全体的にプロフェッショナルな見た目

【スマートフォン】
5. スマホでアクセス（または開発者ツールでモバイル表示）
6. グラフが画面幅に収まる
7. テキストが読みやすいサイズ
8. スクロールがスムーズ
9. タップ操作が快適

【エラー処理】
10. Supabase接続を切断（環境変数を一時的に変更）
11. エラー画面が表示される
12. 「再試行」ボタンが機能する

【パフォーマンス】
13. Lighthouseスコア90以上
14. 初回表示3秒以内

全ての項目が確認できればOKです！」
```

---

## ⚠️ 実装上の重要な注意事項

### 1. 環境変数の管理
- **NEXT_PUBLIC_SUPABASE_URL**: 必須
- **NEXT_PUBLIC_SUPABASE_ANON_KEY**: 必須
- ローカルは`.env.local`、本番はVercelで設定

### 2. データの扱い
- タイムスタンプはUTCで保存されている
- 表示時は日本時間（JST）に変換する
- group_idは「default-group」でフィルタリング

### 3. パフォーマンス
- 表示データは最新1000件まで
- 古いデータは自動的にメモリから削除
- グラフの再描画は最小限に抑える

### 4. セキュリティ
- Row Level Security (RLS)は現在無効
- 将来的に認証機能を追加する場合は有効化
- Anon Keyは公開可能（読み取り専用）

## 📚 関連ドキュメント

- [Supabase公式ドキュメント](https://supabase.com/docs)
- [Next.js公式ドキュメント](https://nextjs.org/docs)
- [Chart.js公式ドキュメント](https://www.chartjs.org/docs/)
- [Recharts公式ドキュメント](https://recharts.org/)

---

**このドキュメントは実装の進捗に応じて更新してください。**