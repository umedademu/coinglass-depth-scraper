# æ™‚é–“è¶³å°‚ç”¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…è¨ˆç”»

## ğŸ“Œ ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

ã“ã‚Œã¯BTC-USDTæ¿æƒ…å ±ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ‘ãƒ¼ã«ãŠã„ã¦ã€å„æ™‚é–“è¶³å°‚ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®è¨ˆç”»æ›¸ã§ã™ã€‚
ç¾åœ¨ã®æ··åœ¨ã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ•´ç†ã—ã€RealtimeåŒæœŸã‚’æ­£å¸¸ã«æ©Ÿèƒ½ã•ã›ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

**é‡è¦**: å®Ÿè£…ã‚’å§‹ã‚ã‚‹å‰ã«ã€å¿…ãšã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚

## ğŸ¯ å®Ÿè£…æ–¹é‡

1. **ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨åˆ†é›¢**: å„æ™‚é–“è¶³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç‹¬ç«‹ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†
2. **æ—¢å­˜æ©Ÿèƒ½ã®ç¶­æŒ**: 1åˆ†è¶³ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚°ãƒ©ãƒ•è¡¨ç¤ºæ©Ÿèƒ½ã¯ãã®ã¾ã¾æ´»ç”¨
3. **æ®µéšçš„ç§»è¡Œ**: å‹•ä½œç¢ºèªã—ãªãŒã‚‰ç€å®Ÿã«æ©Ÿèƒ½ã‚’è¿½åŠ 
4. **æœ€å¤§å€¤æ¡ç”¨ã®å¾¹åº•**: ãƒ­ãƒ¼ã‚«ãƒ«ã¨Supabaseã®ãƒ‡ãƒ¼ã‚¿ã‚’å¸¸ã«æ¯”è¼ƒã—ã€å¤§ãã„å€¤ã‚’æ¡ç”¨
5. **RealtimeåŒæœŸã®æ­£å¸¸åŒ–**: å„æ™‚é–“è¶³ã®UPDATEã‚¤ãƒ™ãƒ³ãƒˆã‚’é©åˆ‡ãªãƒ†ãƒ¼ãƒ–ãƒ«ã«åæ˜ 

## ğŸ“ å®Ÿè£…ã®å‰ææ¡ä»¶

### ç¾åœ¨ã®å•é¡Œç‚¹
- 1åˆ†è¶³DBã«5åˆ†è¶³ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒæ··å…¥ã—ã¦ã„ã‚‹
- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨Supabaseã®ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ºãƒ¬ã¦ã„ã‚‹
- RealtimeåŒæœŸã§å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚°ãƒ©ãƒ•ã«åæ˜ ã•ã‚Œãªã„
- ãƒ‡ãƒ¼ã‚¿ã®ç²’åº¦ãŒæ··åœ¨ã—ã€ã‚°ãƒ©ãƒ•ãŒã‚®ã‚¶ã‚®ã‚¶ã«ãªã‚‹

### ç¾åœ¨ã®æ§‹æˆ
- **1åˆ†è¶³**: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã€`order_book_history`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
- **3åˆ†è¶³**: 1åˆ†è¶³ã‹ã‚‰å‹•çš„ç”Ÿæˆï¼ˆDBãªã—ï¼‰
- **5åˆ†è¶³ä»¥ä¸Š**: Supabaseã«ä¿å­˜ã€Realtimeã§åŒæœŸï¼ˆç¾åœ¨ã¯1åˆ†è¶³DBã«èª¤ã£ã¦ä¿å­˜ï¼‰

### ç›®æ¨™æ§‹æˆ
- **1åˆ†è¶³**: ç¾çŠ¶ç¶­æŒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã€`order_book_history`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- **3åˆ†è¶³**: ç¾çŠ¶ç¶­æŒï¼ˆ1åˆ†è¶³ã‹ã‚‰å‹•çš„ç”Ÿæˆï¼‰
- **5åˆ†è¶³ä»¥ä¸Š**: å„æ™‚é–“è¶³å°‚ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€Supabaseã¨åŒæœŸ

## ğŸ“‹ å®Ÿè£…æ®µéš

### ç¬¬1æ®µéšï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ ğŸ¯é›£æ˜“åº¦: 8/100

#### ç›®æ¨™
å„æ™‚é–“è¶³å°‚ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½œæˆã™ã‚‹ã€‚

#### ã‚¿ã‚¹ã‚¯
- `btc_usdt_order_book.db`ã«7ã¤ã®æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
- ãƒ†ãƒ¼ãƒ–ãƒ«å: `order_book_5min`, `order_book_15min`, `order_book_30min`, `order_book_1hour`, `order_book_2hour`, `order_book_4hour`, `order_book_daily`
- æ—¢å­˜ã®`order_book_history`ã¨åŒã˜ã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ç”¨
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼ˆtimestampï¼‰

#### ç¢ºèªé …ç›®
```
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç¢ºèªæŒ‡ç¤ºï¼š
ã€Œå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
2. ãƒ­ã‚°ã«ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼š
   - "æ™‚é–“è¶³å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ: order_book_5min"
   - "æ™‚é–“è¶³å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ: order_book_15min"
   - ï¼ˆå…¨7ãƒ†ãƒ¼ãƒ–ãƒ«åˆ†ï¼‰
3. SQLiteãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªï¼ˆä»»æ„ï¼‰ï¼š
   - btc_usdt_order_book.dbã‚’é–‹ã
   - 8ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ï¼ˆorder_book_history + 7ã¤ã®æ–°è¦ï¼‰

å•é¡Œãªã‘ã‚Œã°OKã§ã™ï¼ã€
```

---

### ç¬¬2æ®µéšï¼šãƒ‡ãƒ¼ã‚¿ä¿å­˜å…ˆã®æŒ¯ã‚Šåˆ†ã‘ ğŸ¯é›£æ˜“åº¦: 12/100

#### ç›®æ¨™
ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ãªæ™‚é–“è¶³ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã™ã‚‹ã€‚

#### ã‚¿ã‚¹ã‚¯
- `save_to_database`ãƒ¡ã‚½ãƒƒãƒ‰ã®æ‹¡å¼µ
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã‚‰è©²å½“ã™ã‚‹æ™‚é–“è¶³ã‚’åˆ¤å®š
- 5åˆ†ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã¯`order_book_5min`ã«ä¿å­˜
- 15åˆ†ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã¯`order_book_15min`ã«ä¿å­˜ï¼ˆä»¥ä¸‹åŒæ§˜ï¼‰
- 1åˆ†è¶³ãƒ‡ãƒ¼ã‚¿ã¯å¾“æ¥é€šã‚Š`order_book_history`ã«ä¿å­˜

#### å®Ÿè£…å†…å®¹
```python
# ä¿å­˜å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
if dt.minute % 5 == 0:
    # order_book_5minã«ä¿å­˜
if dt.minute in [0, 15, 30, 45]:
    # order_book_15minã«ä¿å­˜
if dt.minute in [0, 30]:
    # order_book_30minã«ä¿å­˜
# ... ä»¥ä¸‹åŒæ§˜
```

#### ç¢ºèªé …ç›®
```
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç¢ºèªæŒ‡ç¤ºï¼š
ã€Œå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’5åˆ†ä»¥ä¸Šå®Ÿè¡Œ
2. 5åˆ†çµŒéå¾Œã€ãƒ­ã‚°ã«ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼š
   - "[5åˆ†è¶³DB] ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜: 13:05:00"
3. 15åˆ†çµŒéå¾Œã€ãƒ­ã‚°ã«ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼š
   - "[15åˆ†è¶³DB] ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜: 13:15:00"
4. order_book_5minãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹

ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãæŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚Œã°OKã§ã™ï¼ã€
```

---

### ç¬¬3æ®µéšï¼šSupabaseãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒãƒ»æ›´æ–° ğŸ¯é›£æ˜“åº¦: 18/100

#### ç›®æ¨™
Supabaseã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ãƒ¼ã‚«ãƒ«DBã‚’æ¯”è¼ƒã—ã€æœ€å¤§å€¤ã‚’æ¡ç”¨ã™ã‚‹ã€‚

#### ã‚¿ã‚¹ã‚¯
- `fetch_initial_timeframe_data`ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£
- å„æ™‚é–“è¶³ãƒ‡ãƒ¼ã‚¿ã‚’å¯¾å¿œã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯æœ€å¤§å€¤æ¯”è¼ƒ
- INSERT OR REPLACEã§ã¯ãªãã€æ˜ç¤ºçš„ãªæ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…

#### å®Ÿè£…å†…å®¹
```python
# æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
existing = cursor.execute(
    "SELECT ask_total, bid_total FROM order_book_5min WHERE timestamp = ?",
    (timestamp,)
).fetchone()

if existing:
    # æœ€å¤§å€¤ã‚’é¸æŠ
    ask = max(supabase_ask, existing[0])
    bid = max(supabase_bid, existing[1])
    # UPDATEå®Ÿè¡Œ
else:
    # INSERTå®Ÿè¡Œ
```

#### ç¢ºèªé …ç›®
```
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç¢ºèªæŒ‡ç¤ºï¼š
ã€Œå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
2. èµ·å‹•æ™‚ãƒ­ã‚°ã«ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼š
   - "[åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—] 5åˆ†è¶³: 1000ä»¶å–å¾—"
   - "[ãƒ­ãƒ¼ã‚«ãƒ«DB] 5åˆ†è¶³: æ–°è¦300ä»¶ã€æ›´æ–°50ä»¶"
3. ãƒ­ãƒ¼ã‚«ãƒ«DBã®å€¤ãŒSupabaseã®å€¤ä»¥ä¸Šã«ãªã£ã¦ã„ã‚‹
4. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥å¾Œã€å¤§ãã„å€¤ãŒæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹

æœ€å¤§å€¤æ¯”è¼ƒãŒæ©Ÿèƒ½ã—ã¦ã„ã‚Œã°OKã§ã™ï¼ã€
```

---

### ç¬¬4æ®µéšï¼šRealtimeåŒæœŸã®ä¿®æ­£ ğŸ¯é›£æ˜“åº¦: 15/100

#### ç›®æ¨™
Realtimeã§å—ä¿¡ã—ãŸUPDATEã‚¤ãƒ™ãƒ³ãƒˆã‚’é©åˆ‡ãªæ™‚é–“è¶³ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã™ã‚‹ã€‚

#### ã‚¿ã‚¹ã‚¯
- `save_realtime_data_to_local_db`ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£
- table_nameã‹ã‚‰ä¿å­˜å…ˆã‚’åˆ¤å®š
- å„æ™‚é–“è¶³å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ä¿å­˜å‡¦ç†
- æœ€å¤§å€¤æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã®é©ç”¨

#### å®Ÿè£…å†…å®¹
```python
# ãƒ†ãƒ¼ãƒ–ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚°
# æ³¨: 5åˆ†è¶³ã®Supabaseãƒ†ãƒ¼ãƒ–ãƒ«å'order_book_shared'ã¯
#     å°†æ¥çš„ã«'order_book_5min'ã«çµ±ä¸€ã•ã‚Œã‚‹äºˆå®š
table_mapping = {
    'order_book_shared': 'order_book_5min',  # å°†æ¥çš„ã«'order_book_5min'ã«å¤‰æ›´äºˆå®š
    'order_book_15min': 'order_book_15min',
    'order_book_30min': 'order_book_30min',
    # ... ä»¥ä¸‹åŒæ§˜
}

local_table = table_mapping.get(supabase_table_name)
# local_tableã«ä¿å­˜
```

#### ç¢ºèªé …ç›®
```
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç¢ºèªæŒ‡ç¤ºï¼š
ã€Œå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
2. Supabaseã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆ50,000ãªã©å¤§ãã„å€¤ï¼‰
3. ãƒ­ã‚°ã«ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼š
   - "[Realtime] 5åˆ†è¶³ã®æ›´æ–°ã‚’æ¤œå‡º"
   - "[5åˆ†è¶³DB] Realtimeãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜: Ask=50,000"
4. order_book_5minãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„å€¤ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹
5. 1åˆ†è¶³DBã«ã¯æ··å…¥ã—ã¦ã„ãªã„

RealtimeåŒæœŸãŒæ­£ã—ãå‹•ä½œã™ã‚Œã°OKã§ã™ï¼ã€
```

---

### ç¬¬5æ®µéšï¼šã‚°ãƒ©ãƒ•è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ âœ…å®Œäº† ğŸ¯é›£æ˜“åº¦: 20/100

#### ç›®æ¨™
æ™‚é–“è¶³é¸æŠã«å¿œã˜ã¦ã€é©åˆ‡ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

#### ã‚¿ã‚¹ã‚¯
- `update_graph`ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£
- 5åˆ†è¶³ä»¥ä¸Šã¯å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
- 1åˆ†è¶³ãƒ»3åˆ†è¶³ã¯å¾“æ¥é€šã‚Šï¼ˆ`order_book_history`ã‹ã‚‰å‹•çš„ç”Ÿæˆï¼‰
- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
- **é‡è¦: å¤‰æ•°åã®çµ±ä¸€ï¼ˆfiltered_times â†’ timesï¼‰**

#### âš ï¸ å®Ÿè£…ä¸Šã®é‡è¦ãªæ³¨æ„äº‹é …
```
è­¦å‘Š: å¤‰æ•°åã®çµ±ä¸€ãŒå¿…è¦ã§ã™ï¼
- å¾“æ¥ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ filtered_times, filtered_asks, filtered_bids ã‚’ä½¿ç”¨
- æ–°å®Ÿè£…ã§ã¯ times, asks, bids ã«çµ±ä¸€ã™ã‚‹
- ã‚°ãƒ©ãƒ•æç”»å‡¦ç†ã®å…¨ç®‡æ‰€ã§å¤‰æ•°åã‚’ç¢ºèªãƒ»ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
  - ãƒ‡ãƒ¼ã‚¿å–å¾—éƒ¨åˆ†: times, asks, bids
  - ã‚°ãƒ©ãƒ•æç”»éƒ¨åˆ†: times, asks, bids
  - Xè»¸ãƒ©ãƒ™ãƒ«è¨­å®š: len(times), times[i] â† ã“ã“ãŒè¦‹è½ã¨ã—ã‚„ã™ã„ï¼
```

#### å®Ÿè£…å†…å®¹
```python
# æ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰1: å‹•çš„ç”Ÿæˆå‡¦ç†ã‚’åˆ†é›¢
def generate_timeframe_data_from_memory(self, interval):
    """1åˆ†è¶³ãƒ»3åˆ†è¶³ç”¨ã®å‹•çš„ç”Ÿæˆï¼ˆå¾“æ¥å‡¦ç†ã‚’åˆ¥ãƒ¡ã‚½ãƒƒãƒ‰åŒ–ï¼‰"""
    filtered_times = []  # ã“ã®å†…éƒ¨ã§ã¯ filtered_* ã‚’ä½¿ç”¨
    # ... å‡¦ç† ...
    return filtered_times, filtered_asks, filtered_bids  # æˆ»ã‚Šå€¤

# æ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰2: DBã‹ã‚‰ã®ç›´æ¥èª­ã¿è¾¼ã¿
def load_timeframe_data_from_db(self, table_name, limit=300):
    """5åˆ†è¶³ä»¥ä¸Šã®å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿"""
    # ... å‡¦ç† ...
    return times, asks, bids  # ç›´æ¥ times ã¨ã—ã¦è¿”ã™

# ä¿®æ­£ã•ã‚ŒãŸupdate_graphãƒ¡ã‚½ãƒƒãƒ‰
def update_graph(self):
    if timeframe in timeframe_tables:  # 5åˆ†è¶³ä»¥ä¸Š
        times, asks, bids = self.load_timeframe_data_from_db(table_name)
    else:  # 1åˆ†è¶³ãƒ»3åˆ†è¶³
        times, asks, bids = self.generate_timeframe_data_from_memory(interval)
    
    # âš ï¸ ä»¥é™ã€å…¨ã¦times/asks/bidsã§çµ±ä¸€ï¼ˆfiltered_*ã¯ä½¿ã‚ãªã„ï¼‰
    # ã‚°ãƒ©ãƒ•æç”»å‡¦ç†...
    self.ax_ask.plot(times, asks, ...)  # OK
    
    # Xè»¸ãƒ©ãƒ™ãƒ«è¨­å®šï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
    data_count = len(times)  # len(filtered_times)ã§ã¯ãªã„ï¼
    tick_positions.append(times[i])  # filtered_times[i]ã§ã¯ãªã„ï¼
```

#### ç¢ºèªé …ç›®
```
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç¢ºèªæŒ‡ç¤ºï¼š
ã€Œå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
2. 5åˆ†è¶³ã‚’é¸æŠï¼š
   - order_book_5minã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
   - 50,000ãªã©ã®å¤§ãã„å€¤ãŒæ­£ã—ãè¡¨ç¤º
   - ã‚°ãƒ©ãƒ•ãŒã‚®ã‚¶ã‚®ã‚¶ã«ãªã‚‰ãªã„
3. 1æ™‚é–“è¶³ã‚’é¸æŠï¼š
   - order_book_1hourã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
   - é©åˆ‡ãªé–“éš”ã§ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
4. 1åˆ†è¶³ã‚’é¸æŠï¼š
   - å¾“æ¥é€šã‚Šã®è¡¨ç¤ºï¼ˆå¤‰æ›´ãªã—ï¼‰

å„æ™‚é–“è¶³ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ï¼ã€
```

---

### ç¬¬6æ®µéšï¼šãƒ‡ãƒ¼ã‚¿ç§»è¡Œã¨æœ€é©åŒ– ğŸ¯é›£æ˜“åº¦: 25/100

#### ç›®æ¨™
æ—¢å­˜ã®æ··åœ¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã™ã‚‹ã€‚

#### ã‚¿ã‚¹ã‚¯
- æ—¢å­˜ã®`order_book_history`ã‹ã‚‰5åˆ†è¶³ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
- å„æ™‚é–“è¶³ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»è¡Œ
- 1åˆ†è¶³DBã‹ã‚‰ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
- VACUUMå®Ÿè¡Œ

#### ç¢ºèªé …ç›®
```
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ç¢ºèªæŒ‡ç¤ºï¼š
ã€Œå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
1. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
2. ãƒ­ã‚°ã«ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼š
   - "ãƒ‡ãƒ¼ã‚¿ç§»è¡Œé–‹å§‹"
   - "5åˆ†è¶³: 1,000ä»¶ã‚’ç§»è¡Œ"
   - "1åˆ†è¶³DB: 5,000ä»¶ã®ä¸è¦ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤"
   - "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æœ€é©åŒ–ã—ã¾ã—ãŸ"
3. ã‚°ãƒ©ãƒ•è¡¨ç¤ºãŒé«˜é€ŸåŒ–ã—ã¦ã„ã‚‹
4. 1åˆ†è¶³ã‚°ãƒ©ãƒ•ãŒã‚®ã‚¶ã‚®ã‚¶ã§ãªããªã£ã¦ã„ã‚‹

ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒãŒå®Œäº†ã—ã¦ã„ã‚Œã°OKã§ã™ï¼ã€
```

---

## âš ï¸ å®Ÿè£…ä¸Šã®é‡è¦ãªæ³¨æ„äº‹é …

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
- æ—¢å­˜ã®`btc_usdt_order_book.db`ã«æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
- ã‚¹ã‚­ãƒ¼ãƒã¯`order_book_history`ã¨åŒä¸€
- PRIMARY KEYã¯`timestamp`
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä½¿ç”¨ã§æ•´åˆæ€§ã‚’ä¿è¨¼

### 2. ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®çµ±ä¸€
- **é‡è¦**: Supabaseã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆé–‹å§‹æ™‚åˆ»ï¼‰ã§ãƒ‡ãƒ¼ã‚¿ä¿å­˜
- 13:05ã®5åˆ†è¶³ = 13:05:00ã®ãƒ‡ãƒ¼ã‚¿
- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚‚é–‹å§‹æ™‚åˆ»ã‚’æ¡ç”¨ï¼ˆçµ‚å€¤ã§ã¯ãªãï¼‰

### 3. æœ€å¤§å€¤æ¡ç”¨ã®åŸå‰‡
- å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã¨Supabaseã‚’æ¯”è¼ƒ
- å¤§ãã„å€¤ã‚’æ¡ç”¨
- UPDATEã®å ´åˆã‚‚åŒæ§˜ã®å‡¦ç†

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®
- å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã¯æœ€å¤§10,000ä»¶ã«åˆ¶é™
- å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯å®šæœŸçš„ã«å‰Šé™¤
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é©åˆ‡ã«è¨­å®š

### 5. äº’æ›æ€§ã®ç¶­æŒ
- 1åˆ†è¶³ã¨3åˆ†è¶³ã®å‡¦ç†ã¯å¤‰æ›´ã—ãªã„
- æ—¢å­˜ã®ã‚°ãƒ©ãƒ•è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’æœ€å¤§é™æ´»ç”¨
- ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®å‹•ä½œã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

## ğŸ”§ å®Ÿè£…è©³ç´°

### ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQL
```sql
CREATE TABLE IF NOT EXISTS order_book_5min (
    timestamp TEXT PRIMARY KEY,
    ask_total REAL NOT NULL,
    bid_total REAL NOT NULL,
    price REAL NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_5min_timestamp 
ON order_book_5min(timestamp);

-- ä»–ã®æ™‚é–“è¶³ã‚‚åŒæ§˜ã«ä½œæˆ
```

### ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯
```python
def save_to_timeframe_db(self, table_name, timestamp, ask, bid, price):
    """æ™‚é–“è¶³å°‚ç”¨DBã¸ã®ä¿å­˜"""
    cursor = self.conn.cursor()
    
    # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
    cursor.execute(f"""
        SELECT ask_total, bid_total FROM {table_name}
        WHERE timestamp = ?
    """, (timestamp,))
    
    existing = cursor.fetchone()
    if existing:
        # æœ€å¤§å€¤ã§æ›´æ–°
        if ask > existing[0] or bid > existing[1]:
            cursor.execute(f"""
                UPDATE {table_name}
                SET ask_total = ?, bid_total = ?, price = ?
                WHERE timestamp = ?
            """, (
                max(ask, existing[0]),
                max(bid, existing[1]),
                price,
                timestamp
            ))
    else:
        # æ–°è¦æŒ¿å…¥
        cursor.execute(f"""
            INSERT INTO {table_name}
            (timestamp, ask_total, bid_total, price)
            VALUES (?, ?, ?, ?)
        """, (timestamp, ask, bid, price))
    
    self.conn.commit()
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆ1åˆ†ã”ã¨ï¼‰
    â†“
1åˆ†è¶³DBï¼ˆorder_book_historyï¼‰
    â†“
5åˆ†ã”ã¨ã®åˆ¤å®š
    â†“
5åˆ†è¶³DBï¼ˆorder_book_5minï¼‰
    â†“
Supabaseã¨æ¯”è¼ƒãƒ»æœ€å¤§å€¤æ¡ç”¨
    â†“
ã‚°ãƒ©ãƒ•è¡¨ç¤ºï¼ˆå°‚ç”¨DBã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
```

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªä»•æ§˜æ›¸](./desktop-app-spec.md)
- [RealtimeåŒæœŸä»•æ§˜æ›¸](./realtime-error-fix-requirements.md)
- [æ—©ã„è€…å‹ã¡å•é¡Œã®è§£æ±º](./previous-candle-monitoring-requirements.md)

---

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å®Ÿè£…ã®é€²æ—ã«å¿œã˜ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€‚**