# 時間足切り替え時のズーム・パン状態維持機能 要件定義書

## 1. 概要

### 1.1 機能概要
チャートのズーム・パン状態を時間足切り替え後も概ね維持することで、ユーザーが注目している時間範囲での分析を継続可能にする機能。

### 1.2 背景と目的
- **現状の課題**: 時間足を切り替えるとズーム・パン状態がリセットされ、全体表示に戻ってしまう
- **ユーザーニーズ**: 特定の期間に注目して分析している際、異なる時間足でも同じ期間を確認したい
- **目的**: TradingViewのような直感的な時間足切り替え体験を提供

## 2. 機能要件

### 2.1 状態の保持

#### 2.1.1 保持する情報
- **時間範囲**: 現在表示している期間の開始・終了時刻
- **ズームレベル**: 表示データ点数または時間幅
- **パン位置**: 表示範囲の中心時刻

#### 2.1.2 保持のタイミング
- ズーム操作完了時
- パン操作完了時
- 時間足切り替え直前

### 2.2 状態の復元

#### 2.2.1 復元方式
- **近似的復元**: 完全に同じ範囲ではなく、概ね同じ時間帯を表示
- **時間ベース**: データインデックスではなく時刻を基準に復元
- **自動調整**: データが存在しない場合は最も近い有効範囲に調整

#### 2.2.2 復元処理
1. 保持していた時間範囲を新しい時間足のデータで検索
2. 該当する期間のデータインデックスを特定
3. Chart.jsのズーム範囲として適用
4. 表示を更新

### 2.3 ユーザー体験

#### 2.3.1 期待される動作
- **1時間足で特定の3日間を拡大表示** → **日足に切り替え** → 同じ3日間付近が表示される
- **5分足で特定の2時間を表示** → **15分足に切り替え** → 同じ2時間付近が表示される
- **日足で1ヶ月を表示** → **4時間足に切り替え** → 同じ1ヶ月の期間が表示される

#### 2.3.2 エッジケース処理
- **データ不足**: 要求期間のデータが一部しか存在しない場合、利用可能な範囲で最大限表示
- **期間超過**: 保持期間が新しい時間足の全データ期間を超える場合、全体表示にフォールバック
- **初回切り替え**: ズーム・パンしていない状態では全体表示を維持

## 3. 非機能要件

### 3.1 パフォーマンス
- **切り替え速度**: 時間足切り替え後、500ms以内に状態復元完了
- **計算効率**: O(log n)以下の時間計算量で範囲を特定
- **メモリ使用**: 状態保持に必要なメモリは100バイト以下

### 3.2 精度
- **時間精度**: ±5%の誤差範囲内で時間範囲を復元
- **データ点数**: 表示データ点数は元の50%～200%の範囲内
- **中心位置**: 表示範囲の中心は元の時刻の±10%以内

### 3.3 ユーザビリティ
- **透明性**: ユーザーに特別な操作を要求しない
- **予測可能性**: 一貫した動作で混乱を避ける
- **リセット可能**: ズームリセットボタンで初期状態に戻せる

## 4. 実装仕様

### 4.1 データ構造

```typescript
interface ZoomPanState {
  // 時間ベースの範囲
  timeRange: {
    start: Date;  // 表示開始時刻
    end: Date;    // 表示終了時刻
  };
  
  // 相対的な位置情報
  relativePosition: {
    centerRatio: number;  // 全体に対する中心位置の比率（0.0～1.0）
    zoomLevel: number;    // ズームレベル（1.0が全体表示）
  };
  
  // メタ情報
  metadata: {
    timeframe: TimeframeKey;  // 保存時の時間足
    dataPoints: number;        // 表示していたデータ点数
    savedAt: Date;            // 保存時刻
  };
}
```

### 4.2 状態管理

#### 4.2.1 保存場所
- **メモリ内**: Reactの状態またはRefとして保持
- **永続化なし**: ページリロード時はリセット（現行動作と一致）

#### 4.2.2 更新トリガー
- Chart.jsの`onZoomComplete`コールバック
- Chart.jsの`onPanComplete`コールバック

### 4.3 復元アルゴリズム

```typescript
// 擬似コード
function restoreZoomPanState(
  savedState: ZoomPanState,
  newData: OrderBookData[],
  newTimeframe: TimeframeKey
): ChartZoomRange {
  // 1. 時間範囲をデータインデックスに変換
  const startIndex = findClosestIndex(newData, savedState.timeRange.start);
  const endIndex = findClosestIndex(newData, savedState.timeRange.end);
  
  // 2. データが存在するか確認
  if (startIndex === -1 || endIndex === -1) {
    // フォールバック：相対位置で復元
    return calculateRelativeRange(savedState.relativePosition, newData);
  }
  
  // 3. 範囲の妥当性チェック
  const range = validateRange(startIndex, endIndex, newData.length);
  
  return {
    x: { min: range.start, max: range.end }
  };
}
```

## 5. 制約事項

### 5.1 技術的制約
- Chart.jsのズームAPIの制限内で実装
- 既存のリアルタイム更新機能と競合しない
- forwardRefパターンを維持

### 5.2 データ制約
- 異なる時間足間でデータの粒度が大きく異なる（5分足と日足では288倍の差）
- 過去データの利用可能期間が時間足により異なる
- リアルタイムデータ追加時の範囲調整が必要

## 6. テストシナリオ

### 6.1 基本シナリオ
1. 1時間足で特定期間をズーム
2. 5分足に切り替え → 同じ時間帯が表示される
3. 日足に切り替え → 同じ時間帯が表示される
4. 元の1時間足に戻る → 最初のズーム状態が復元される

### 6.2 エッジケースシナリオ
1. 最新データのみをズーム → 時間足切り替え → 最新データ付近を表示
2. 最古データのみをズーム → 時間足切り替え → 利用可能な最古データを表示
3. 全体表示 → 時間足切り替え → 全体表示を維持

## 7. 実装優先度

### 7.1 必須機能（MVP）
- 時間範囲の保持と復元
- 基本的な時間足切り替え対応
- エラーハンドリング

### 7.2 追加機能（将来）
- より精密な位置復元
- アニメーション付き遷移
- 複数のズーム履歴管理
- キーボードショートカット対応

## 8. 成功指標

### 8.1 定量的指標
- 状態復元成功率: 95%以上
- 時間範囲の精度: ±5%以内
- パフォーマンス低下: 10%未満

### 8.2 定性的指標
- ユーザーが違和感なく時間足を切り替えられる
- 分析作業の継続性が保たれる
- TradingViewユーザーが慣れ親しんだ操作感

## 改訂履歴
- 2025-01-19: 初版作成