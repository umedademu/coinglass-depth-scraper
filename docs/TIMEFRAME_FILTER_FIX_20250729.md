# 時間足フィルタリング修正要件定義書

作成日: 2025/07/29

## 1. 現状の問題

### 問題の概要
- 現在の実装は配列のインデックスベースでデータをフィルタリング（間引き）している
- 「1データ = 1分」を前提としているため、5分間隔のデータでは正しく動作しない
- 例：1時間足を表示する際、5分間隔データでは5時間刻みになってしまう

### 問題のあるコード
```python
if (i + 1) % interval == 0 or i == len(self.time_history) - 1:
    # インデックスで60個ごとに採用 → データ間隔を考慮していない
```

## 2. 修正方針

### 基本方針
- インデックスベースから時刻ベースのグルーピングに変更
- データの実際のタイムスタンプを使用して適切な時間足を生成

### 実装要件
1. **時刻ベースのグルーピング**
   - 各データのタイムスタンプから所属する時間帯を判定
   - 例：14:23のデータ → 1時間足なら14:00-14:59のグループ

2. **代表値の選択**
   - 各時間帯グループから終値（最後の値）を採用
   - グループ内で最も新しいタイムスタンプのデータを使用

3. **データ欠損への対応**
   - 時間帯の最後（:59）のデータが欠損している場合
   - その時間帯で利用可能な最も新しいデータを採用
   - 例：14:59欠損 → 14:58を採用、それも欠損なら14:57...と遡る

## 3. 技術仕様

### 修正対象
- `update_graph()`メソッドのフィルタリング処理部分のみ
- データ構造の変更は不要（`self.time_history`は既にdatetimeオブジェクト）

### 処理フロー
1. 時間足の種類から時間帯の幅を決定（1時間、4時間など）
2. 全データを時間帯ごとにグループ化
3. 各グループから最新のデータを選択
4. 選択されたデータでグラフを描画

### データ間隔の自動認識
- 連続するデータのタイムスタンプ差から実際のデータ間隔を検出
- 1分間隔、5分間隔など、どのような間隔でも正しく処理

## 4. 期待される結果

- データ間隔に関わらず、正しい時間足表示が可能
- 新規PCでクラウドから5分間隔データを取得しても、1時間足は24本表示
- 既存のデータ収集・保存・同期機能への影響なし

## 5. 注意事項

- 既存のデータベース構造は変更しない
- クラウド同期の仕組みは変更しない
- パフォーマンスへの影響を最小限に抑える